parameters:
  location: ''
  subscription: ''
  azureDevOpsE2EJSONSPN: ''

steps:
# TODO(mj) we need to checkout code to run tooling like kubeconfig. This should go away once we refactor everything into golang.
- template: ./template-checkout.yml
- template: ./template-az-cli-login.yml
  parameters:
    azureDevOpsJSONSPN: ${{ parameters.azureDevOpsE2EJSONSPN }}
- script: |
    set -e
    export LOCATION=${{ parameters.location }}
    export AZURE_SUBSCRIPTION_ID=${{ parameters.subscription }}

    trap 'rm -f devops-spn.json' EXIT
    base64 -d >devops-spn.json <<<${{ parameters.azureDevOpsE2EJSONSPN }}
    export AZURE_CLIENT_ID=$(jq -r .clientId <devops-spn.json)
    export AZURE_CLIENT_SECRET=$(jq -r .clientSecret <devops-spn.json)
    export AZURE_TENANT_ID=$(jq -r .tenantId <devops-spn.json)

    set -x
    . ./hack/e2e/run-rp-and-e2e.sh

    export CI=true
    export ARO_IMAGE="$RP_IMAGE_ACR:$(get_e2e_image_version)"
    export TEST_E2E="docker run \
                --network host \
                --env-file <(env | egrep 'AZURE|E2E|ARO') \
                --env LOCATION \
                --env CI \
                --env RESOURCEGROUP \
                --env CLUSTER \
                --env RP_MODE \
                --entrypoint e2e.test $ARO_IMAGE"

    export RESOURCEGROUP=$ARO_RESOURCEGROUP
    export TEST_E2E=$TEST_E2E

    make test-e2e
  displayName: ðŸš€ Run ${{ parameters.location }} E2E
- template: ./template-az-cli-logout.yml
